name: Release

# Trigger on version tags (v*)
on:
  push:
    tags:
      - 'v*'

# Minimal permissions - request only what's needed per job
permissions:
  contents: write # Required for creating releases

jobs:
  build:
    name: Build Release Assets
    runs-on: ubuntu-latest

    permissions:
      contents: write
      id-token: write # Required for SLSA provenance
      actions: read

    outputs:
      hashes: ${{ steps.hash.outputs.hashes }}
      version: ${{ steps.version.outputs.version }}

    steps:
      # Security hardening
      - name: Harden Runner
        uses: step-security/harden-runner@0080882f6c36860b6ba35c610c98ce87d4e2f26f # v2.10.2
        with:
          egress-policy: audit

      # Checkout with full history to generate changelog
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
          persist-credentials: false

      # Extract version from tag
      - name: Get version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION}"

      # Setup pnpm
      - name: Setup pnpm
        uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0
        with:
          version: 9

      # Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: '20'
          cache: 'pnpm'

      # Install dependencies with frozen lockfile
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Build production assets
      - name: Build production
        run: pnpm build

      # Create release archive
      - name: Create release archive
        run: |
          cd dist
          tar -czf ../quizmaster-${{ steps.version.outputs.version }}.tar.gz .
          cd ..
          zip -r quizmaster-${{ steps.version.outputs.version }}.zip dist/

      # Generate checksums for artifacts
      - name: Generate artifact checksums
        id: hash
        run: |
          sha256sum quizmaster-${{ steps.version.outputs.version }}.tar.gz > checksums.txt
          sha256sum quizmaster-${{ steps.version.outputs.version }}.zip >> checksums.txt
          cat checksums.txt
          echo "hashes=$(sha256sum quizmaster-${{ steps.version.outputs.version }}.tar.gz quizmaster-${{ steps.version.outputs.version }}.zip | base64 -w0)" >> $GITHUB_OUTPUT

      # Generate changelog from commits
      - name: Generate changelog
        id: changelog
        run: |
          # Get the previous tag
          PREVIOUS_TAG=$(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1) 2>/dev/null || echo "")

          if [ -z "$PREVIOUS_TAG" ]; then
            # First release - get all commits
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            # Get commits since previous tag
            CHANGELOG=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi

          # Save changelog to file
          echo "## Changes" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "$CHANGELOG" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "## Checksums" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo '```' >> CHANGELOG.md
          cat checksums.txt >> CHANGELOG.md
          echo '```' >> CHANGELOG.md

      # Create GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@da05f76bf4bb6f372eddf54c83b0a09cb3e711e5 # v2.2.1
        with:
          files: |
            quizmaster-${{ steps.version.outputs.version }}.tar.gz
            quizmaster-${{ steps.version.outputs.version }}.zip
            checksums.txt
          body_path: CHANGELOG.md
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, 'alpha') || contains(steps.version.outputs.version, 'beta') || contains(steps.version.outputs.version, 'rc') }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fail_on_unmatched_files: true

  # Generate SLSA provenance for supply chain security
  provenance:
    name: Generate SLSA Provenance
    needs: [build]
    permissions:
      actions: read
      id-token: write
      contents: write
    # Use the official SLSA provenance generator
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@v2.0.0
    with:
      base64-subjects: "${{ needs.build.outputs.hashes }}"
      upload-assets: true
      upload-tag-name: ${{ github.ref_name }}
      provenance-name: "quizmaster-${{ needs.build.outputs.version }}.intoto.jsonl"
